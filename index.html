<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>SoundPainter å¯è§†éŸ³ä¹</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
<style>
body { margin: 0; overflow: hidden; background-color: black; }
.controls {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(8px);
  padding: 15px;
  border-radius: 15px;
  color: white;
  z-index: 10;
  font-family: "Arial", sans-serif;
  box-shadow: 0 4px 20px rgba(255, 255, 255, 0.2);
}
.controls select, .controls input, .controls button {
  margin: 5px 0;
  padding: 6px 10px;
  border-radius: 8px;
  border: none;
  background: rgba(255,255,255,0.15);
  color: white;
}
.controls label {
  display: block;
  margin-top: 5px;
  font-weight: bold;
}
.controls button:hover {
  background: rgba(255,255,255,0.3);
  cursor: pointer;
}
</style>
</head>
<body>

<div class="controls">
  <label>ğŸ¶ é€‰æ‹©å†…ç½®éŸ³ä¹</label>
  <select id="music-select">
    <option value="none">æ— </option>
    <option value="bach.mp3">å·´èµ« - å“¥å¾·å ¡å˜å¥æ›²</option>
    <option value="beethoven.mp3">è´å¤šèŠ¬ - äº¤å“æ›²</option>
    <option value="chopin.mp3">è‚–é‚¦ - å¤œæ›²</option>
  </select>

  <label>ğŸ“¤ ä¸Šä¼ éŸ³ä¹</label>
  <input type="file" id="upload" accept="audio/*">

  <label>ğŸ¨ ç»˜ç”»æ¨¡å¼</label>
  <select id="mode-select">
    <option value="abstract">æŠ½è±¡ç”»</option>
    <option value="realistic">å…·è±¡ç»˜ç”»</option>
  </select>

  <label>ğŸ–¼ï¸ å…·è±¡ç»˜ç”»é£æ ¼</label>
  <select id="image-select">
    <option value="0">å·´æ´›å…‹</option>
    <option value="1">å¤å…¸</option>
    <option value="2">æµªæ¼«</option>
    <option value="3">å°è±¡æ´¾</option>
  </select>

  <label>ğŸŒˆ è‰²å½©é£æ ¼</label>
  <select id="color-select">
    <option value="default">é»˜è®¤</option>
    <option value="cool">å†·è‰²è°ƒ</option>
    <option value="warm">æš–è‰²è°ƒ</option>
    <option value="bw">é»‘ç™½</option>
    <option value="colorful">å¤šå½©</option>
  </select>

  <label>ğŸ–Œï¸ ç¬”è§¦é£æ ¼</label>
  <select id="brush-select">
    <option value="oil">æ²¹ç”»</option>
    <option value="pixel">åƒç´ </option>
    <option value="dot">ç‚¹é˜µ</option>
    <option value="watercolor">æ°´å½©</option>
    <option value="random">éšæœº</option>
  </select>

  <br>
  <button id="play-btn">â–¶ï¸ æ’­æ”¾</button>
  <button id="pause-btn">â¸ï¸ æš‚åœ</button>
</div>

<script>
let song;
let fft;
let amp;
let imgList = [];
let spectrum = [];

let mode = 'abstract';
let colorMode = 'default';
let brushMode = 'oil';
let imageIndex = 0;

function preload() {
  imgList[0] = loadImage('baroque.jpg');       // å·´æ´›å…‹
  imgList[1] = loadImage('classical.jpg');      // å¤å…¸
  imgList[2] = loadImage('romantic.jpg');       // æµªæ¼«
  imgList[3] = loadImage('impressionism.jpg');  // å°è±¡æ´¾
}

function setup() {
  createCanvas(windowWidth, windowHeight);
  fft = new p5.FFT();
  amp = new p5.Amplitude();

  document.getElementById('upload').addEventListener('change', handleFile);
  document.getElementById('music-select').addEventListener('change', (e) => {
    if (e.target.value === "none") {
      if (song) song.stop();
      song = null;
      return;
    }
    loadMusic(e.target.value);
  });

  document.getElementById('mode-select').addEventListener('change', (e) => mode = e.target.value);
  document.getElementById('color-select').addEventListener('change', (e) => colorMode = e.target.value);
  document.getElementById('brush-select').addEventListener('change', (e) => brushMode = e.target.value);
  document.getElementById('image-select').addEventListener('change', (e) => imageIndex = parseInt(e.target.value));

  document.getElementById('play-btn').addEventListener('click', () => {
    if (song) song.play();
  });

  document.getElementById('pause-btn').addEventListener('click', () => {
    if (song) song.pause();
  });
}

function handleFile(event) {
  const file = event.target.files[0];
  if (file) {
    if (song) song.stop();
    song = loadSound(URL.createObjectURL(file), () => {
      song.play();
    });
  }
}

function loadMusic(filename) {
  if (song) song.stop();
  song = loadSound(filename, () => {
    song.play();
  }, () => {
    alert("éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚");
  });
}

function applyColors(r, g, b) {
  switch(colorMode) {
    case 'cool': return color(r*0.6, g*0.7, b);
    case 'warm': return color(r, g*0.7, b*0.6);
    case 'bw': 
      let v = (r + g + b)/3;
      return color(v);
    case 'colorful':
      return color(random(255), random(255), random(255));
    default:
      return color(r, g, b);
  }
}

function draw() {
  background(0, 50);

  if (song && song.isPlaying()) {
    spectrum = fft.analyze();
    let level = amp.getLevel();

    if (mode === 'abstract') {
      drawAbstract(level);
    } else if (mode === 'realistic') {
      drawRealistic(level);
    }
  }
}

function drawAbstract(level) {
  let size = map(level, 0, 1, 100, 500);
  noStroke();
  fill(applyColors(200, 100, 255), 180);
  ellipse(width / 2, height / 2, size);

  translate(width / 2, height / 2);
  stroke(applyColors(100, 255, 200));
  noFill();
  beginShape();
  for (let i = 0; i < spectrum.length; i += 10) {
    let angle = map(i, 0, spectrum.length, 0, TWO_PI);
    let r = map(spectrum[i], 0, 255, 150, 400);
    let x = r * cos(angle);
    let y = r * sin(angle);
    vertex(x, y);
  }
  endShape(CLOSE);
  resetMatrix();
}

function drawRealistic(level) {
  let img = imgList[imageIndex];
  let step = int(map(level, 0, 0.3, 5, 50));

  for (let i = 0; i < step; i++) {
    let x = random(width);
    let y = random(height);
    let imgX = int(map(x, 0, width, 0, img.width));
    let imgY = int(map(y, 0, height, 0, img.height));
    let c = img.get(imgX, imgY);
    let col = applyColors(c[0], c[1], c[2]);

    noStroke();
    fill(col, 200);

    switch(brushMode) {
      case 'oil':
        ellipse(x, y, random(10, 20));
        break;
      case 'pixel':
        rect(x, y, 10, 10);
        break;
      case 'dot':
        ellipse(x, y, 5);
        break;
      case 'watercolor':
        ellipse(x, y, random(20, 40));
        break;
      case 'random':
        if (random(1) > 0.5) {
          ellipse(x, y, random(10, 30));
        } else {
          rect(x, y, random(10, 30), random(10, 30));
        }
        break;
    }
  }
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}
</script>
</body>
</html>
